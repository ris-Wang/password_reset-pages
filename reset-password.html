<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>重置密码</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
    <h2>设置新密码</h2>
    <input type="password" id="newPassword" placeholder="输入新密码" />
    <button onclick="resetPassword()">提交</button>
    <p id="status"></p>

    <script>
        // 先创建 Supabase 客户端，避免变量冲突
        const supabaseClient = supabase.createClient(
            "https://obuoiocdddymcuekcfqk.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9idW9pb2NkZGR5bWN1ZWtjZnFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjAyNzUsImV4cCI6MjA2Nzc5NjI3NX0.965hNL2AV7k9IyXUnuUxvfuMB5xcgE4Lfbgw5k8By0U"
        );

        // 从 URL hash 提取参数
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get("access_token");
        const refreshToken = hashParams.get("refresh_token");
        const error = hashParams.get("error");

        if (error) {
            const msg = hashParams.get("error_description") || "未知错误";
            document.getElementById("status").textContent = "链接无效：" + msg;
        }

        async function resetPassword() {
            const newPassword = document.getElementById("newPassword").value;

            if (!newPassword) {
                document.getElementById("status").textContent = "请输入新密码";
                return;
            }

            // 恢复会话
            const { error: sessionError } = await supabaseClient.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken,
            });

            if (sessionError) {
                document.getElementById("status").textContent = "会话恢复失败：" + sessionError.message;
                return;
            }

            // 更新密码
            const { error } = await supabaseClient.auth.updateUser({
                password: newPassword,
            });

            if (error) {
                document.getElementById("status").textContent = "密码更新失败：" + error.message;
            } else {
                document.getElementById("status").textContent = "密码更新成功，请重新登录。";
            }
        }
    </script>
</body>
</html>
